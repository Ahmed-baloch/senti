// Search for log4j and jndi in devices with MDE (Advanced hunting)
DeviceTvmSoftwareInventory
| where SoftwareName contains "log4j" and SoftwareName contains "jndi"
| project DeviceName, SoftwareName, SoftwareVersion

#------------------------------------------------------------------#

DeviceTvmSoftwareVulnerabilitiesKB
| where CveId == "CVE-2021-44228"
| where VulnerabilityDescription == @"Apache Log4j2 JNDI features do not protect against attacker controlled LDAP and other JNDI related endpoints. Apache Log4j versions prior to 2.15.0 are susceptible to a vulnerability. An attacker who can control log messages or log message parameters can execute arbitrary code loaded from LDAP servers when message lookup substitution is enabled. From log4j 2.15.0, this behavior has been disabled by default. The full list of impacted applications has not yet been determined at this point. Microsoft is continuously investigating the vulnerability and affected applications. We will update this entry additional information guidance as more details become available."

#------------------------------------------------------------------#

DeviceTvmSoftwareVulnerabilitiesKB
| where CveId == "CVE-2021-44228"
| where AffectedSoftware contains "log4j"

#------------------------------------------------------------------#

union DeviceEvents, DeviceNetworkEvents, DeviceImageLoadEvents
| where FileName contains "Log4J" 
    or InitiatingProcessFileName == @"java.exe" 
    or InitiatingProcessVersionInfoOriginalFileName == @"java.exe"
    
#------------------------------------------------------------------#

union DeviceEvents, DeviceNetworkEvents, DeviceImageLoadEvents
| where FileName contains "Log4J" 
    or InitiatingProcessFileName == @"java.exe" 
    or InitiatingProcessVersionInfoOriginalFileName == @"java.exe"
| where ActionType contains "ConnectionSuccess"
