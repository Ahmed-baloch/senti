// Potential exploitation of Apache log4j component detected with external payloads
let l4j = (externaldata(ip:string) [@"https://gist.githubusercontent.com/nathanqthai/01808c569903f41a52e7e7b575caa890/raw/813de735bb6e074f630a2520e07d79362983f6ab/payloads_no_base64.csv"]with(format="csv")
| where ip matches regex "(^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$)" | distinct ip );
let log4jcmd = dynamic(["jndi:ldap","jndi:dns","jndi:rmi","jndi:corba","jndi:iiop","jndi:nis","jndi:nds"]);
AzureDiagnostics
| where IPAddress in (l4j)
| where originalRequestUriWithArgs_s has_any (log4jcmd)
| where userAgent_s has_any ("curl")
| summarize Total = count() by originalRequestUriWithArgs_s, userAgent_s, clientIP_s, TimeGenerated, host_s, requestUri_s, httpStatus_d,listenerName_s
| sort by originalRequestUriWithArgs_s asc, Total desc 
